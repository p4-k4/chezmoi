#!/bin/bash

# This script runs whenever the flake.nix content changes
# flake.nix hash: {{ include "flake.nix" | sha256sum }}

echo "Detected changes in flake.nix, rebuilding..."

# Source nix if it exists
if [ -e '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh' ]; then
    . '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh'
fi

# Clean up existing profiles
echo "Removing existing profiles..."
while IFS= read -r profile_id; do
    if [ ! -z "$profile_id" ]; then
        echo "Removing profile ID: $profile_id"
        nix profile remove "$profile_id"
    fi
done < <(nix profile list | grep -v "^$" | tail -n +2 | cut -d' ' -f1)

# Clean up old generations and garbage collect
echo "Cleaning up old generations and garbage collecting..."
if command -v sudo >/dev/null 2>&1; then
    sudo nix-collect-garbage -d
else
    echo "Warning: sudo not available. Running garbage collection without root privileges."
    nix-collect-garbage -d
fi

# Update and rebuild the flake
cd {{ .chezmoi.sourceDir }} && \
echo "Updating flake..." && \
nix flake update && \
echo "Building..." && \
nix build && \
echo "Installing new profile..." && \
nix profile install .#default

# Verify installation
if [ $? -eq 0 ]; then
    echo "Successfully rebuilt and installed new configuration"
else
    echo "Error: Failed to install new configuration"
    exit 1
fi
