#!/bin/bash

# This script runs whenever the flake.nix content changes
# flake.nix hash: {{ include "flake.nix" | sha256sum }}

set -e  # Exit on error

echo "Detected changes in flake.nix, rebuilding..."

# Source nix if it exists
if [ -e '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh' ]; then
    . '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh'
fi

cd {{ .chezmoi.sourceDir }}

# Update flake
echo "Updating flake..."
nix flake update

# Build new configuration
echo "Building..."
nix build

# Switch to the new configuration
echo "Switching to new configuration..."
# First try to remove any existing profile
nix profile remove '.#default' 2>/dev/null || true
# Then install the new one
nix profile install '.#default' --accept-flake-config

# Clean up old generations
echo "Cleaning up old generations..."
nix store gc

# Source the new profile
if [ -e "$HOME/.nix-profile/etc/profile.d/nix.sh" ]; then
    . "$HOME/.nix-profile/etc/profile.d/nix.sh"
fi

echo "Flake update complete. New profile state:"
nix profile list

# Rehash to ensure new commands are available
hash -r
