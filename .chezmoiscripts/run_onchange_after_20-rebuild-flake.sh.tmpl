#!/bin/bash

# This script runs whenever the flake.nix content changes
# flake.nix hash: {{ include "flake.nix" | sha256sum }}

echo "Detected changes in flake.nix, rebuilding..."

# Source nix if it exists
if [ -e '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh' ]; then
    . '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh'
fi

# Clean up existing profiles
echo "Removing existing profiles..."
if nix profile list | grep -q "default"; then
    echo "Removing existing default profile..."
    nix profile remove "git+file://$(pwd)#default" || true
fi

# Clean up old store paths
echo "Running garbage collection..."
nix store gc

# Update and rebuild the flake
cd {{ .chezmoi.sourceDir }} && \
echo "Updating flake..." && \
nix flake update && \
echo "Building..." && \
nix build && \
echo "Installing new profile..." && \
nix profile install .#default --accept-flake-config

# Verify installation
if [ $? -eq 0 ]; then
    echo "Successfully rebuilt and installed new configuration"
    
    # Source the new profile to make new commands available immediately
    if [ -e "$HOME/.nix-profile/etc/profile.d/nix.sh" ]; then
        . "$HOME/.nix-profile/etc/profile.d/nix.sh"
    fi
else
    echo "Error: Failed to install new configuration"
    exit 1
fi

# Verify specific packages are available
if ! command -v cowsay &> /dev/null; then
    echo "Warning: cowsay command not found after installation. Please check your flake.nix configuration."
fi
