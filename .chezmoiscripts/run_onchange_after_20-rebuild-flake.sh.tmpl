#!/bin/bash

# This script runs whenever the flake.nix content changes
# flake.nix hash: {{ include "flake.nix" | sha256sum }}

echo "Detected changes in flake.nix, rebuilding..."

# Source nix if it exists
if [ -e '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh' ]; then
    . '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh'
fi

# Clean up existing profile
echo "Removing existing profile..."
nix profile remove '.*'

# Update and rebuild the flake
cd {{ .chezmoi.sourceDir }} && \
nix flake update && \
nix build && \
echo "Installing new profile..." && \
nix profile install .#default
